From 61a599c085c7e1d9ffbf47ad96224de3899a8ee8 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Tue, 18 Jul 2017 18:28:49 -0400
Subject: [PATCH] CVE-2017-11644

A special crafted file create a memory leak in MAT file coder. The
code need to free two buffer in some exceptionnal circonstance, instead than just one

bug-debian:ttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=870016
bug: https://github.com/ImageMagick/ImageMagick/issues/587
origin: https://github.com/ImageMagick/ImageMagick/commit/418f88dd18af34b6cb64f709567c81b89865d7bc
---
 coders/mat.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/mat.c b/coders/mat.c
index df7751a04..5de6ee1ed 100644
--- a/coders/mat.c
+++ b/coders/mat.c
@@ -1351,6 +1351,8 @@ END_OF_READING:
     clone_info = NULL;
   }
   if (logging) (void)LogMagickEvent(CoderEvent,GetMagickModule(),"return");
+  if ((image != image2) && (image2 != (Image *) NULL))
+    image2=DestroyImage(image2);
   if(image==NULL)
     ThrowReaderException(CorruptImageError,"ImproperImageHeader");
   return (image);
