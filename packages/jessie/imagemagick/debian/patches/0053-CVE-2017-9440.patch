From fbf30c6e7d23d60a21c7c5be0792dd262b0e2cfc Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Tue, 2 May 2017 09:05:15 +0200
Subject: [PATCH] CVE-2017-9440

A memory leak was found in the function ReadPSDChannel in coders/psd.c, which allows attackers to cause a denial of service via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/462
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=864273
origin: https://github.com/ImageMagick/ImageMagick/commit/c2be129c25763680afeca59f4de5d6d4240ca2cf

(cherry picked from commit c2be129c25763680afeca59f4de5d6d4240ca2cf)
---
 coders/psd.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/psd.c b/coders/psd.c
index fb93c57dd..2f4a02f11 100644
--- a/coders/psd.c
+++ b/coders/psd.c
@@ -1202,12 +1202,14 @@ static MagickBooleanType ReadPSDChannelZip(Image *image,const size_t channels,
         ret=inflate(&stream, Z_SYNC_FLUSH);
         if ((ret != Z_OK) && (ret != Z_STREAM_END))
           {
+            (void) inflateEnd(&stream);
             compact_pixels=(unsigned char *) RelinquishMagickMemory(
               compact_pixels);
             pixels=(unsigned char *) RelinquishMagickMemory(pixels);
             return(MagickFalse);
           }
       }
+      (void) inflateEnd(&stream);
     }
 
   if (compression == ZipWithPrediction)
