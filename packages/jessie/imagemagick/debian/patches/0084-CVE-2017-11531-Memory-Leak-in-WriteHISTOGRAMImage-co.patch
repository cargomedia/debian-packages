From 858da8c5e4987a6a08b896cda296424d0d0b0381 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 16 Jul 2017 19:58:44 -0400
Subject: [PATCH] CVE-2017-11531 Memory-Leak in WriteHISTOGRAMImage()
 coders/histogram.c

A crafted file could trigger a
Memory-Leak in WriteHISTOGRAMImage() coders/histogram.c

bug: https://github.com/ImageMagick/ImageMagick/issues/566
bug-debian: : https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=869725
origin: https://github.com/ImageMagick/ImageMagick/commit/c81594c6ee93581b97e8f8c743200b1366d83989
---
 coders/histogram.c | 4 ----
 coders/msl.c       | 3 +--
 magick/draw.c      | 4 ++--
 3 files changed, 3 insertions(+), 8 deletions(-)

diff --git a/coders/histogram.c b/coders/histogram.c
index f7e844bf7..d8df0aefd 100644
--- a/coders/histogram.c
+++ b/coders/histogram.c
@@ -383,11 +383,7 @@ static MagickBooleanType WriteHISTOGRAMImage(const ImageInfo *image_info,
       (LocaleCompare(write_info->magick,"HISTOGRAM") == 0))
     (void) FormatLocaleString(histogram_image->filename,MaxTextExtent,
       "miff:%s",write_info->filename);
-  histogram_image->blob=(BlobInfo *) DetachBlob(histogram_image->blob);
-  histogram_image->blob=CloneBlobInfo(image->blob);
   status=WriteImage(write_info,histogram_image);
-  image->blob=(BlobInfo *) DetachBlob(image->blob);
-  image->blob=CloneBlobInfo(histogram_image->blob);
   histogram_image=DestroyImage(histogram_image);
   write_info=DestroyImageInfo(write_info);
   return(status);
diff --git a/coders/msl.c b/coders/msl.c
index 0b72b82bb..a7648150a 100644
--- a/coders/msl.c
+++ b/coders/msl.c
@@ -7697,8 +7697,7 @@ static MagickBooleanType ProcessMSLScript(const ImageInfo *image_info,
       (msl_info.image == (Image **) NULL) ||
       (msl_info.attributes == (Image **) NULL) ||
       (msl_info.group_info == (MSLGroupInfo *) NULL))
-    ThrowFatalException(ResourceLimitFatalError,
-      "UnableToInterpretMSLImage");
+    ThrowFatalException(ResourceLimitFatalError,"UnableToInterpretMSLImage");
   *msl_info.image_info=CloneImageInfo(image_info);
   *msl_info.draw_info=CloneDrawInfo(image_info,(DrawInfo *) NULL);
   *msl_info.attributes=AcquireImage(image_info);
diff --git a/magick/draw.c b/magick/draw.c
index 1f2a88675..5e6152ca0 100644
--- a/magick/draw.c
+++ b/magick/draw.c
@@ -1751,6 +1751,8 @@ MagickExport MagickBooleanType DrawImage(Image *image,const DrawInfo *draw_info)
     return(MagickFalse);
   if (image->debug != MagickFalse)
     (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
+  if (SetImageStorageClass(image,DirectClass) == MagickFalse)
+    return(MagickFalse);
   if (*draw_info->primitive != '@')
     primitive=AcquireString(draw_info->primitive);
   else
@@ -1792,8 +1794,6 @@ MagickExport MagickBooleanType DrawImage(Image *image,const DrawInfo *draw_info)
   token=AcquireString(primitive);
   extent=strlen(token)+MaxTextExtent;
   (void) QueryColorDatabase("#000000",&start_color,&image->exception);
-  if (SetImageStorageClass(image,DirectClass) == MagickFalse)
-    return(MagickFalse);
   status=MagickTrue;
   for (q=primitive; *q != '\0'; )
   {
