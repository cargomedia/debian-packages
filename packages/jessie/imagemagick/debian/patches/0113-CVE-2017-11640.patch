From 55810d35f0a473e451a5452b8b37fcced36897fa Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Tue, 18 Jul 2017 12:52:44 -0400
Subject: [PATCH] CVE-2017-11640

When ImageMagick 7.0.6-1 processes a crafted file in convert, it can
lead to an address access exception in the WritePTIFImage() function
in coders/tiff.c.

Incorporate fix of 1fcd0feb93b51b9363176097ee5f360c62687d86

bug: https://github.com/ImageMagick/ImageMagick/issues/584
bug-debian: https://bugs.debian.org/870067
origin: https://github.com/ImageMagick/ImageMagick/commit/46fe9920da054714d1d9c2c02a595f1fe733373d,
 https://github.com/ImageMagick/ImageMagick/commit/1fcd0feb93b51b9363176097ee5f360c62687d86

(cherry picked from commit 46fe9920da054714d1d9c2c02a595f1fe733373d)
---
 coders/tiff.c | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/coders/tiff.c b/coders/tiff.c
index 2f6840367..38f47f890 100644
--- a/coders/tiff.c
+++ b/coders/tiff.c
@@ -2669,14 +2669,19 @@ static MagickBooleanType WritePTIFImage(const ImageInfo *image_info,
       AppendImageToList(&images,pyramid_image);
     }
   }
-  /*
-    Write pyramid-encoded TIFF image.
-  */
-  write_info=CloneImageInfo(image_info);
-  write_info->adjoin=MagickTrue;
-  status=WriteTIFFImage(write_info,GetFirstImageInList(images));
-  images=DestroyImageList(images);
-  write_info=DestroyImageInfo(write_info);
+  status=MagickFalse;
+  if (images != (Image *) NULL)
+    {
+      /*
+        Write pyramid-encoded TIFF image.
+      */
+      images=GetFirstImageInList(images);
+      write_info=CloneImageInfo(image_info);
+      write_info->adjoin=MagickTrue;
+      status=WriteTIFFImage(write_info,images);
+      images=DestroyImageList(images);
+      write_info=DestroyImageInfo(write_info);
+    }
   return(status);
 }
 #endif
