From 855c70dfa7367b199b463d24a7a6805da87066d5 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 24 Jun 2017 12:14:47 -0400
Subject: [PATCH] CPU exhaustion in ReadOneJNGImage

Due to lack of validation of PNG format, imagemagick could loop
2^32 in a CPU intensive loop.

bug: https://github.com/ImageMagick/ImageMagick/issues/526
bug: https://github.com/ImageMagick/ImageMagick/issues/527
bug-debian: https://bugs.debian.org/867824
bug-debian: https://bugs.debian.org/867825
origin: https://github.com/ImageMagick/ImageMagick/commit/5d43fdf7a1f18f36e45225f121697d7f13c8cba9

(cherry picked from commit 5d43fdf7a1f18f36e45225f121697d7f13c8cba9)
---
 coders/png.c | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/coders/png.c b/coders/png.c
index f9bc4bd82..593c468fe 100644
--- a/coders/png.c
+++ b/coders/png.c
@@ -4173,7 +4173,13 @@ static Image *ReadOneJNGImage(MngInfo *mng_info,
           ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
 
         for (i=0; i < (ssize_t) length; i++)
-          chunk[i]=(unsigned char) ReadBlobByte(image);
+        {
+          int
+            c;
+
+          c=ReadBlobByte(image);
+          chunk[i]=(unsigned char) c;
+        }
 
         p=chunk;
       }
@@ -5026,7 +5032,13 @@ static Image *ReadOneMNGImage(MngInfo* mng_info, const ImageInfo *image_info,
               ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
 
             for (i=0; i < (ssize_t) length; i++)
-              chunk[i]=(unsigned char) ReadBlobByte(image);
+            {
+              int
+                c;
+
+              c=ReadBlobByte(image);
+              chunk[i]=(unsigned char) c;
+            }
 
             p=chunk;
           }
