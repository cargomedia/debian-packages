From cba86d89ada0bf05e2ee3a109dad8738972eb95c Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Tue, 2 May 2017 08:37:52 +0200
Subject: [PATCH] CVE-2017-9409: the ReadMPCImage function in mpc.c allows
 attackers to cause a denial of service (memory leak) via a crafted file.

origin: https://github.com/ImageMagick/ImageMagick/commit/492991ed21c1d233287fda884044c0cc222b2161
bug: https://github.com/ImageMagick/ImageMagick/issues/458
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=864090

(cherry picked from commit 492991ed21c1d233287fda884044c0cc222b2161)
---
 coders/mpc.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/coders/mpc.c b/coders/mpc.c
index 89fead527..ca479dc43 100644
--- a/coders/mpc.c
+++ b/coders/mpc.c
@@ -864,12 +864,16 @@ static Image *ReadMPCImage(const ImageInfo *image_info,ExceptionInfo *exception)
               ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
             count=ReadBlob(image,packet_size*image->colors,colormap);
             if (count != (ssize_t) (packet_size*image->colors))
-              ThrowReaderException(CorruptImageError,
-                "InsufficientImageDataInFile");
+              {
+                colormap=(unsigned char *) RelinquishMagickMemory(colormap);
+                ThrowReaderException(CorruptImageError,
+                  "InsufficientImageDataInFile");
+              }
             p=colormap;
             switch (depth)
             {
               default:
+                colormap=(unsigned char *) RelinquishMagickMemory(colormap);
                 ThrowReaderException(CorruptImageError,
                   "ImageDepthNotSupported");
               case 8:
