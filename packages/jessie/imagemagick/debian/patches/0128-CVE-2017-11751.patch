From 699d2757f53281c1b32eb21b3c8f4506a5a9e349 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 30 Jul 2017 06:06:33 -0400
Subject: [PATCH] CVE-2017-11751

The WritePICONImage function in coders/xpm.c in ImageMagick 7.0.6-4
allows remote attackers to cause a denial of service (memory leak) via
a crafted file.

bug-debian: https://bugs.debian.org/870481
bug: https://github.com/ImageMagick/ImageMagick/issues/631
origin: https://github.com/ImageMagick/ImageMagick/commit/b04e9c949d917a4a603f1a9bfe09737246229323
---
 coders/xpm.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/coders/xpm.c b/coders/xpm.c
index 415d84fe0..9e089cc2e 100644
--- a/coders/xpm.c
+++ b/coders/xpm.c
@@ -712,7 +712,13 @@ static MagickBooleanType WritePICONImage(const ImageInfo *image_info,
   (void) RelinquishUniqueFileResource(blob_info->filename);
   blob_info=DestroyImageInfo(blob_info);
   if ((picon == (Image *) NULL) || (affinity_image == (Image *) NULL))
-    return(MagickFalse);
+    {
+      if (affinity_image != (Image *) NULL)
+        affinity_image=DestroyImage(affinity_image);
+      if (picon != (Image *) NULL)
+        picon=DestroyImage(picon);
+      return(MagickFalse);
+    }
   quantize_info=AcquireQuantizeInfo(image_info);
   status=RemapImage(quantize_info,picon,affinity_image);
   quantize_info=DestroyQuantizeInfo(quantize_info);
