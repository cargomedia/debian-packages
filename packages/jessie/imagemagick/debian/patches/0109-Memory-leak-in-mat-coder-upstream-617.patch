From 2cd929703f0cc1b75f8f7ea793c8ef58446c30d4 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Tue, 25 Jul 2017 08:22:39 -0400
Subject: [PATCH] Memory leak in mat coder (upstream 617)

bug-debian: https://bugs.debian.org/870021
bug: https://github.com/ImageMagick/ImageMagick/issues/617
origin: https://github.com/ImageMagick/ImageMagick/commit/f9b992dd2a4caab1dace919f9190b2c173a4e18c

(cherry picked from commit f9b992dd2a4caab1dace919f9190b2c173a4e18c)
---
 coders/mat.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/mat.c b/coders/mat.c
index 24e20c11c..909a84206 100644
--- a/coders/mat.c
+++ b/coders/mat.c
@@ -934,6 +934,8 @@ static Image *ReadMATImage(const ImageInfo *image_info,ExceptionInfo *exception)
   if (strncmp(MATLAB_HDR.identific, "MATLAB", 6))
     {
 MATLAB_KO:
+      if ((image != image2) && (image2 != (Image *) NULL))
+        image2=DestroyImage(image2);
       if (clone_info != (ImageInfo *) NULL)
         clone_info=DestroyImageInfo(clone_info);
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
