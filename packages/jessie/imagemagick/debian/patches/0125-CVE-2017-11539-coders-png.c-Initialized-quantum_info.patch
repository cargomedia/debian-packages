From 8eeeba438d8eceade3e6770c25058425c668ab6e Mon Sep 17 00:00:00 2001
From: Glenn Randers-Pehrson <glennrp@gmail.com>
Date: Fri, 28 Jul 2017 08:13:20 -0400
Subject: [PATCH] CVE-2017-11539: coders/png.c: Initialized quantum_info to
 prevent memory leakage

bug-debian: https://bugs.debian.org/870120
bug: https://github.com/ImageMagick/ImageMagick/issues/582
origin: https://github.com/ImageMagick/ImageMagick/commit/4e81160d66f02bf7b4f569669ca7dd80d416ba6e
---
 coders/png.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/coders/png.c b/coders/png.c
index 53d2e5396..b5df01d93 100644
--- a/coders/png.c
+++ b/coders/png.c
@@ -1973,6 +1973,9 @@ static Image *ReadOnePNGImage(MngInfo *mng_info,
   Quantum
     *volatile quantum_scanline;
 
+  QuantumInfo
+    *volatile quantum_info;
+
   ssize_t
     j;
 
@@ -2127,6 +2130,7 @@ static Image *ReadOnePNGImage(MngInfo *mng_info,
 
   pixel_info=(MemoryInfo *) NULL;
   quantum_scanline = (Quantum *) NULL;
+  quantum_info = (QuantumInfo *) NULL;
 
   if (setjmp(png_jmpbuf(ping)))
     {
@@ -2141,6 +2145,8 @@ static Image *ReadOnePNGImage(MngInfo *mng_info,
       if (quantum_scanline != (Quantum *) NULL)
         quantum_scanline=(Quantum *) RelinquishMagickMemory(quantum_scanline);
 
+      quantum_info=DestroyQuantumInfo(quantum_info);
+
 #ifdef IMPNG_SETJMP_NOT_THREAD_SAFE
       UnlockSemaphoreInfo(ping_semaphore);
 #endif
@@ -3111,9 +3117,6 @@ static Image *ReadOnePNGImage(MngInfo *mng_info,
 
   if (image->storage_class == DirectClass)
     {
-      QuantumInfo
-        *quantum_info;
-
       quantum_info=AcquireQuantumInfo(image_info,image);
 
       if (quantum_info == (QuantumInfo *) NULL)
