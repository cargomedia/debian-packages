From 4659b12895e6862a4cc45f00dcaad372a9298767 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Wed, 3 May 2017 23:58:25 +0200
Subject: [PATCH] CVE-2017-8765

The function named ReadICONImage in coders\icon.c in ImageMagick has a memory leak vulnerability which can cause memory exhaustion via a crafted ICON file.

Added extra check that was reported in #466.

(cherry picked from commit b3299a3f2ec597172b092e9f7b71d2c9e75287c7)

origin: https://github.com/ImageMagick/ImageMagick/commit/b3299a3f2ec597172b092e9f7b71d2c9e75287c7
bug: https://github.com/ImageMagick/ImageMagick/issues/466
bug-debian: https://bugs.debian.org/862653
---
 coders/icon.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/coders/icon.c b/coders/icon.c
index c0530c308..b94fa05fa 100644
--- a/coders/icon.c
+++ b/coders/icon.c
@@ -433,7 +433,7 @@ static Image *ReadICONImage(const ImageInfo *image_info,
         {
           image->storage_class=PseudoClass;
           image->colors=icon_info.number_colors;
-          if (image->colors == 0)
+          if ((image->colors == 0) || (image->colors > 256))
             image->colors=one << icon_info.bits_per_pixel;
         }
       if (image->storage_class == PseudoClass)
