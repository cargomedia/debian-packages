From f6924aa228c041c174a93512d430b4b9aa2d92e6 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Mon, 24 Jul 2017 09:34:03 -0400
Subject: [PATCH] CVE-2017-11532: memory leak

When Imagemagick processes a crafted file in convert, it can lead to a Memory Leak in the WriteMPCImage() function in coders/mpc.c.

The previous fix is not universal and need this change.

bug: https://github.com/ImageMagick/ImageMagick/issues/563
origin:  https://github.com/ImageMagick/ImageMagick/commit/2bd88257b91b24132d5afdb631c6a9e14f2588cf
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=869726

(cherry picked from commit 2bd88257b91b24132d5afdb631c6a9e14f2588cf)
---
 magick/cache.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/magick/cache.c b/magick/cache.c
index 81353c5dd..65b3d976b 100644
--- a/magick/cache.c
+++ b/magick/cache.c
@@ -4207,8 +4207,9 @@ MagickExport MagickBooleanType PersistPixelCache(Image *image,
   clone_info=(CacheInfo *) clone_image->cache;
   (void) CopyMagickString(clone_info->cache_filename,filename,MaxTextExtent);
   clone_info->mode=PersistMode;
+  clone_info->type=DiskCache;
   clone_info->offset=(*offset);
-  status=ClonePixelCacheRepository(clone_info,image->cache,exception);
+  status=ClonePixelCacheRepository(clone_info,cache_info,exception);
   *offset+=cache_info->length+page_size-(cache_info->length % page_size);
   clone_image=DestroyImage(clone_image);
   return(status);
