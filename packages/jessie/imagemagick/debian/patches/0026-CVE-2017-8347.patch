From 179e116787581da7625a377fa6116a5275144528 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 26 Apr 2017 15:12:55 -0400
Subject: [PATCH] CVE-2017-8347

The ReadEXRImage function in exr.c allows attackers to cause a denial of service (memory leak) via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/441
origin: https://github.com/ImageMagick/ImageMagick/commit/babb3b6c992bef4098ba40353c16d3beba5920a4
bug-debian: https://bugs.debian.org/862577
---
 coders/exr.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/exr.c b/coders/exr.c
index 0e14ee700..c3897f986 100644
--- a/coders/exr.c
+++ b/coders/exr.c
@@ -207,6 +207,7 @@ static Image *ReadEXRImage(const ImageInfo *image_info,ExceptionInfo *exception)
       if (LocaleCompare(image_info->filename,read_info->filename) != 0)
         (void) RelinquishUniqueFileResource(read_info->filename);
       read_info=DestroyImageInfo(read_info);
+      image=DestroyImageList(image);
       return((Image *) NULL);
     }
   hdr_info=ImfInputHeader(file);
@@ -247,6 +248,7 @@ static Image *ReadEXRImage(const ImageInfo *image_info,ExceptionInfo *exception)
           if (LocaleCompare(image_info->filename,read_info->filename) != 0)
             (void) RelinquishUniqueFileResource(read_info->filename);
           read_info=DestroyImageInfo(read_info);
+          image=DestroyImageList(image);
           ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
         }
     }
