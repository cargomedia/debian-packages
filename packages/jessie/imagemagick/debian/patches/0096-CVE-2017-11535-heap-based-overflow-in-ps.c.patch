From 98223fcfb9c9670bcd2a1ef135ee615bbb750543 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 16 Jul 2017 11:19:30 -0400
Subject: [PATCH] CVE-2017-11535: heap based overflow in ps.c

When ImageMagick processes a crafted file in
convert, it can lead to a heap-based buffer over-read in the
WritePSImage() function in coders/ps.c.

bug-debian: https://bugs.debian.org/869827
bug: https://github.com/ImageMagick/ImageMagick/issues/561
origin: https://github.com/ImageMagick/ImageMagick/commit/bba95cfcc19fa8a261e12692f31279148ad42441
(cherry picked from commit bba95cfcc19fa8a261e12692f31279148ad42441)
---
 coders/ps.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/coders/ps.c b/coders/ps.c
index ca7fd6da9..666a75ede 100644
--- a/coders/ps.c
+++ b/coders/ps.c
@@ -1173,7 +1173,7 @@ static MagickBooleanType WritePSImage(const ImageInfo *image_info,Image *image)
 {
 #define WriteRunlengthPacket(image,pixel,length,p) \
 { \
-  if ((image->matte != MagickFalse) && \
+  if ((image->matte != MagickFalse) && (length != 0) &&\
       (GetPixelOpacity(p) == (Quantum) TransparentOpacity)) \
     { \
       q=PopHexPixel(hex_digits,0xff,q); \
