From 1e64fa5d76220cb8debc87700c6f2ae516dfd201 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Mon, 17 Apr 2017 18:52:51 +0200
Subject: [PATCH] Fixed memory leak reported in avs file

Fix CVE-2017-7942

bug: https://github.com/ImageMagick/ImageMagick/issues/429
bug-debian: https://bugs.debian.org/860735
origin: https://github.com/ImageMagick/ImageMagick/commit/fd84a5e8028778fd88772775361a2ee2b4bb6c47
---
 coders/avs.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/coders/avs.c b/coders/avs.c
index a368732ff..50cf05f18 100644
--- a/coders/avs.c
+++ b/coders/avs.c
@@ -178,7 +178,10 @@ static Image *ReadAVSImage(const ImageInfo *image_info,ExceptionInfo *exception)
     {
       count=ReadBlob(image,length,pixels);
       if (count != length)
-        ThrowReaderException(CorruptImageError,"UnableToReadImageData");
+        {
+          pixel_info=RelinquishVirtualMemory(pixel_info);
+          ThrowReaderException(CorruptImageError,"UnableToReadImageData");
+        }
       p=pixels;
       q=QueueAuthenticPixels(image,0,y,image->columns,1,exception);
       if (q == (PixelPacket *) NULL)
