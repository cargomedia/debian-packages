From ffc91d93d4f6795bc37a37e7f242b059c0b53e10 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 16 Jul 2017 11:36:54 -0400
Subject: [PATCH] CVE-2017-11537: palm coder FPE

When ImageMagick processes a crafted file in convert, it can
lead to a Floating Point Exception (FPE) in the WritePALMImage()
function in coders/palm.c, related to an incorrect bits-per-pixel
calculation.

bug: https://github.com/ImageMagick/ImageMagick/issues/560
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=869712
origin: https://github.com/ImageMagick/ImageMagick/commit/bac384563f557d1ac7413d2eaec00dd59c3cc29b

(cherry picked from commit bac384563f557d1ac7413d2eaec00dd59c3cc29b)
---
 coders/palm.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/coders/palm.c b/coders/palm.c
index 5a81c738a..70f03fd73 100644
--- a/coders/palm.c
+++ b/coders/palm.c
@@ -767,10 +767,11 @@ static MagickBooleanType WritePALMImage(const ImageInfo *image_info,
     (void) TransformImageColorspace(image,sRGBColorspace);
     count=GetNumberColors(image,NULL,exception);
     for (bits_per_pixel=1;  (one << bits_per_pixel) < count; bits_per_pixel*=2) ;
-    if (image_info->depth > 100)
-      bits_per_pixel=image_info->depth-100;
-    if (bits_per_pixel < 16)
-      (void) TransformImageColorspace(image,image->colorspace);
+    if (bits_per_pixel > 16)
+      bits_per_pixel=16;
+    else
+      if (bits_per_pixel < 16)
+        (void) TransformImageColorspace(image,image->colorspace);
     if (bits_per_pixel < 8)
       {
         (void) TransformImageColorspace(image,GRAYColorspace);
