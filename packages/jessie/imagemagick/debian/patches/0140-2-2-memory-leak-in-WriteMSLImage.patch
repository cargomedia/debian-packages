From 4fb204337df15093ae17343af6c06f08ce47dc49 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Tue, 18 Jul 2017 13:51:32 -0400
Subject: [PATCH] [2/2] memory leak in WriteMSLImage

Merge upstream three comit in order to improve git bissect

bug-debian: https://bugs.debian.org/870524
bug: https://github.com/ImageMagick/ImageMagick/issues/578
origin; https://github.com/ImageMagick/ImageMagick/commit/dbe0008c6fa225d01085ca86f3e425c306ee624,
 https://github.com/ImageMagick/ImageMagick/commit/d426a1dc84cfdafdac67bdb2a1ecc6e1798053e6,
 https://github.com/ImageMagick/ImageMagick/commit/0dfce0579c881245e495aa2d8d114e63b96a860e
---
 coders/msl.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/coders/msl.c b/coders/msl.c
index c8abb94ab..7efe3302e 100644
--- a/coders/msl.c
+++ b/coders/msl.c
@@ -8261,14 +8261,22 @@ ModuleExport void UnregisterMSLImage(void)
 */
 static MagickBooleanType WriteMSLImage(const ImageInfo *image_info,Image *image)
 {
+  Image
+    *msl_image;
+
+  MagickBooleanType
+    status;
+
   assert(image_info != (const ImageInfo *) NULL);
   assert(image_info->signature == MagickSignature);
   assert(image != (Image *) NULL);
   assert(image->signature == MagickSignature);
   if (image->debug != MagickFalse)
     (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
-  (void) ReferenceImage(image);
-  (void) ProcessMSLScript(image_info,&image,&image->exception);
-  return(MagickTrue);
+  msl_image=CloneImage(image,0,0,MagickTrue,&image->exception);
+  status=ProcessMSLScript(image_info,&msl_image,&image->exception);
+  if (msl_image != (Image *) NULL)
+    msl_image=DestroyImage(msl_image);
+  return(status);
 }
 #endif
