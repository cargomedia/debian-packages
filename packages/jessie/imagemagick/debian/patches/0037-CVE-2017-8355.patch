From edf46bed8867606d2de139af839de73ddbd3fadb Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 26 Apr 2017 17:20:32 -0400
Subject: [PATCH] CVE-2017-8355

the ReadMTVImage function in mtv.c allows attackers to cause a denial of service (memory leak) via a crafted file

bug: https://github.com/ImageMagick/ImageMagick/issues/450
origin: https://github.com/ImageMagick/ImageMagick/commit/d22fd1ff6b41dc81369e255fab81e409049a6e15
bug-debian: https://bugs.debian.org/862634
---
 coders/mtv.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/coders/mtv.c b/coders/mtv.c
index 60f48aa4a..63d84d862 100644
--- a/coders/mtv.c
+++ b/coders/mtv.c
@@ -175,7 +175,10 @@ static Image *ReadMTVImage(const ImageInfo *image_info,ExceptionInfo *exception)
     {
       count=(ssize_t) ReadBlob(image,(size_t) (3*image->columns),pixels);
       if (count != (ssize_t) (3*image->columns))
-        ThrowReaderException(CorruptImageError,"UnableToReadImageData");
+        {
+          pixels=(unsigned char *) RelinquishMagickMemory(pixels);
+          ThrowReaderException(CorruptImageError,"UnableToReadImageData");
+        }
       p=pixels;
       q=QueueAuthenticPixels(image,0,y,image->columns,1,exception);
       if (q == (PixelPacket *) NULL)
