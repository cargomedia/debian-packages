From 745399d9a10ac35a0701e9b4555836e3f4fc4c1c Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Sun, 7 May 2017 11:13:07 +0200
Subject: [PATCH] CVE-2017-8830

The ReadBMPImage function in bmp.c:1379 allows attackers to cause a denial of service (memory leak) via a crafted file.

Replace image in list to fix issue reported in #467.

(cherry picked from commit ff2431d8f17d4a7c906438042a649b04aec93558)

bug: https://github.com/ImageMagick/ImageMagick/issues/467
bug-debian: https://bugs.debian.org/862637
origin: https://github.com/ImageMagick/ImageMagick/commit/ff2431d8f17d4a7c906438042a649b04aec93558
---
 coders/bmp.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/coders/bmp.c b/coders/bmp.c
index 8f9cd69b9..90a6990dd 100644
--- a/coders/bmp.c
+++ b/coders/bmp.c
@@ -1390,7 +1390,7 @@ static Image *ReadBMPImage(const ImageInfo *image_info,ExceptionInfo *exception)
         if (flipped_image != (Image *) NULL)
           {
             DuplicateBlob(flipped_image,image);
-            image=DestroyImage(image);
+            ReplaceImageInList(&image, flipped_image);
             image=flipped_image;
           }
       }
