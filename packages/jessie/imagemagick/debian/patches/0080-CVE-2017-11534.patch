From 838e8e4e98881176794bef52406b06299aab01df Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 16 Jul 2017 15:02:23 -0400
Subject: [PATCH] CVE-2017-11534

Memory-Leak in lite_font_map() coders/wmf.c triggered by a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/564
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=869711
origin: https://github.com/ImageMagick/ImageMagick/commit/3f21b17f06eacb40dab08738e0abf68fb0d58c90

(cherry picked from commit 3f21b17f06eacb40dab08738e0abf68fb0d58c90)
---
 coders/wmf.c | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/coders/wmf.c b/coders/wmf.c
index e7f6ff553..6ef0dff56 100644
--- a/coders/wmf.c
+++ b/coders/wmf.c
@@ -837,7 +837,9 @@ static void ipa_device_close(wmfAPI * API)
       DestroyDrawInfo(ddata->draw_info);
       ddata->draw_info=(DrawInfo *)NULL;
     }
-  RelinquishMagickMemory(WMF_MAGICK_GetFontData(API)->ps_name);
+  if (WMF_MAGICK_GetFontData(API)->ps_name)
+    WMF_MAGICK_GetFontData(API)->ps_name=RelinquishMagickMemory(
+      WMF_MAGICK_GetFontData(API)->ps_name);
 }
 
 /*
@@ -2701,11 +2703,6 @@ static Image *ReadWMFImage(const ImageInfo *image_info,ExceptionInfo *exception)
   wmf_error=wmf_scan(API, 0, &bbox);
   if (wmf_error != wmf_E_None)
     {
-      if (ddata->draw_info != (DrawInfo *) NULL)
-        {
-          DestroyDrawInfo(ddata->draw_info);
-          ddata->draw_info=(DrawInfo *)NULL;
-        }
       if (image->debug != MagickFalse)
         {
           (void) LogMagickEvent(CoderEvent,GetMagickModule(),
@@ -2713,6 +2710,7 @@ static Image *ReadWMFImage(const ImageInfo *image_info,ExceptionInfo *exception)
           (void) LogMagickEvent(CoderEvent,GetMagickModule(),
             "leave ReadWMFImage()");
         }
+      ipa_device_close(API);
       wmf_api_destroy(API);
       ThrowReaderException(DelegateError,"FailedToScanFile");
     }
