From 84460f3d4dfd9d4a576a7cb40da2fba5294559ec Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 26 Apr 2017 17:07:38 -0400
Subject: [PATCH] CVE-2017-8351

The ReadPCDImage function in pcd.c allows attackers to cause a denial
of service (memory leak) via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/448
origin: https://github.com/ImageMagick/ImageMagick/commit/23071f835d44e661177957fde0add67db7788a69
bug-debian: https://bugs.debian.org/862589
---
 coders/pcd.c | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/coders/pcd.c b/coders/pcd.c
index 0500e743b..7076cbe06 100644
--- a/coders/pcd.c
+++ b/coders/pcd.c
@@ -541,12 +541,15 @@ static Image *ReadPCDImage(const ImageInfo *image_info,ExceptionInfo *exception)
   overview=LocaleNCompare((char *) header,"PCD_OPA",7) == 0;
   if ((count != (3*0x800)) ||
       ((LocaleNCompare((char *) header+0x800,"PCD",3) != 0) && (overview == 0)))
-    ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+    {
+      header=(unsigned char *) RelinquishMagickMemory(header);
+      ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+    }
   rotate=header[0x0e02] & 0x03;
   number_images=(header[10] << 8) | header[11];
+  header=(unsigned char *) RelinquishMagickMemory(header);
   if (number_images > 65535)
     ThrowReaderException(CorruptImageError,"ImproperImageHeader");
-  header=(unsigned char *) RelinquishMagickMemory(header);
   /*
     Determine resolution by scene specification.
   */
@@ -686,7 +689,7 @@ static Image *ReadPCDImage(const ImageInfo *image_info,ExceptionInfo *exception)
         }
         image->colorspace=YCCColorspace;
         if (LocaleCompare(image_info->magick,"PCDS") == 0)
-          SetImageColorspace(image,sRGBColorspace);
+          (void) SetImageColorspace(image,sRGBColorspace);
         if (j < (ssize_t) number_images)
           {
             /*
@@ -840,7 +843,7 @@ static Image *ReadPCDImage(const ImageInfo *image_info,ExceptionInfo *exception)
   image->gamma=1.000f/2.200f;
   image->colorspace=YCCColorspace;
   if (LocaleCompare(image_info->magick,"PCDS") == 0)
-    SetImageColorspace(image,sRGBColorspace);
+    (void) SetImageColorspace(image,sRGBColorspace);
   return(GetFirstImageInList(image));
 }
 
