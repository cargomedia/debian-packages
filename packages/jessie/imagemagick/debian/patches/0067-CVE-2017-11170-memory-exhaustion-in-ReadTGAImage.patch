From 4e070c63eec8aefa3628dc0acfc430ac55771083 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 6 May 2017 13:31:00 -0400
Subject: [PATCH] CVE-2017-11170 memory exhaustion in ReadTGAImage

When identify VST file, imagemagick will allocate memory to store data in function ReadTGAImage in coders\tga.c
using tga_info.bits_per_pixel field diretly from VST file without checking in tga.c
By review the founction code, tga_info.bits_per_pixel max valid value is 32.
On 32bit os, size_t one will be 32bit, so image->colors can be overflow to 0.
On 64bit os, size_t one will be 64bit, so image->colors can be large as 0x100000000(64GB).

Original patch was edited to remove magick/image.c modifications that lead to compile error
(reverted in 87664f06ef49a1635cf83ab19981800fc655b746)

bug: CVE-2017-11170 memory exhaustion in ReadTGAImage
origin: https://github.com/ImageMagick/ImageMagick/commit/ea03f17c96467d037d1a21fba1b0b35613658d5b
bug-debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=868184
---
 coders/tga.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/tga.c b/coders/tga.c
index 7b87278ef..2402fe2c5 100644
--- a/coders/tga.c
+++ b/coders/tga.c
@@ -274,6 +274,8 @@ static Image *ReadTGAImage(const ImageInfo *image_info,
 
           one=1;
           image->colors=one << tga_info.bits_per_pixel;
+          if (image->colors > ((~0UL)/sizeof(*image->colormap)))
+            ThrowReaderException(CorruptImageError,"ImproperImageHeader");
           if (AcquireImageColormap(image,image->colors) == MagickFalse)
             ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
         }
