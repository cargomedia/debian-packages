From 96d308f43c9900be4de0a8c048923bb1bc7192c2 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sat, 6 May 2017 13:21:43 -0400
Subject: [PATCH] [2/2] CVE-2017-8352

The ReadXWDImage function in xwd.c allows attackers to cause a denial of service (memory leak) via a crafted file.

bug: https://github.com/ImageMagick/ImageMagick/issues/452
bug-debian: https://bugs.debian.org/862590
origin: https://github.com/ImageMagick/ImageMagick/commit/5964475e21e7e3bdd27835b71aa17d1678c21d7c

(cherry picked from commit 5964475e21e7e3bdd27835b71aa17d1678c21d7c)
---
 coders/xwd.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/xwd.c b/coders/xwd.c
index 3f88bcd76..3ae82e5dc 100644
--- a/coders/xwd.c
+++ b/coders/xwd.c
@@ -325,6 +325,8 @@ static Image *ReadXWDImage(const ImageInfo *image_info,ExceptionInfo *exception)
         color;
 
       length=(size_t) header.ncolors;
+      if (length > ((~0UL)/sizeof(*colors)))
+        ThrowReaderException(CorruptImageError,"ImproperImageHeader");
       colors=(XColor *) AcquireQuantumMemory(length,sizeof(*colors));
       if (colors == (XColor *) NULL)
         {
