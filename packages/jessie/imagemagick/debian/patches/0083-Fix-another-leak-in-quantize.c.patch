From c7f0153953cb080cac947580c58f8c3f9fd071c7 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Mon, 17 Jul 2017 23:15:19 +0200
Subject: [PATCH] Fix another leak in quantize.c

Fix a memory leak in quantize.c

bug: https://github.com/ImageMagick/ImageMagick/issues/574
origin: https://github.com/ImageMagick/ImageMagick/commit/1718df1e042b277a5036d6e6fa9b44587f94afa3
bug-debian:  https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=869722
---
 magick/quantize.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/magick/quantize.c b/magick/quantize.c
index 6d603e257..7690f06f1 100644
--- a/magick/quantize.c
+++ b/magick/quantize.c
@@ -3329,8 +3329,11 @@ static MagickBooleanType SetGrayscaleImage(Image *image)
   colormap=(PixelPacket *) AcquireQuantumMemory(image->colors,
     sizeof(*colormap));
   if (colormap == (PixelPacket *) NULL)
-    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
-      image->filename);
+    {
+      colormap_index=(ssize_t *) RelinquishMagickMemory(colormap_index);
+      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
+        image->filename);
+    }
   j=0;
   colormap[j]=image->colormap[0];
   for (i=0; i < (ssize_t) image->colors; i++)
