From 2e92e839b3f818ecb11f26dbac8540f581f1e57f Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@git.imagemagick.org>
Date: Thu, 27 Apr 2017 12:06:41 +0200
Subject: [PATCH] [1/3] CVE-2017-8350 Fixed more memory leaks.

(cherry picked from commit 8b7af6e1e7163d62fc98add772da73b2f88b31d7)

origin: https://github.com/ImageMagick/ImageMagick/commit/8b7af6e1e7163d62fc98add772da73b2f88b31d7
bug: https://github.com/ImageMagick/ImageMagick/issues/447
bug-debian: https://bugs.debian.org/862587
---
 coders/png.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/coders/png.c b/coders/png.c
index 03e001795..773a0b900 100644
--- a/coders/png.c
+++ b/coders/png.c
@@ -5791,8 +5791,12 @@ static Image *ReadOneMNGImage(MngInfo* mng_info, const ImageInfo *image_info,
                               mng_info->loop_jump[loop_level], SEEK_SET);
 
                             if (offset < 0)
-                              ThrowReaderException(CorruptImageError,
-                                "ImproperImageHeader");
+                              {
+                                chunk=(unsigned char *) RelinquishMagickMemory(
+                                  chunk);
+                                ThrowReaderException(CorruptImageError,
+                                  "ImproperImageHeader");
+                              }
                           }
 
                         else
@@ -6111,7 +6115,10 @@ static Image *ReadOneMNGImage(MngInfo* mng_info, const ImageInfo *image_info,
           }
 #if defined(MNG_INSERT_LAYERS)
         if (length < 8)
-          ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          {
+            chunk=(unsigned char *) RelinquishMagickMemory(chunk);
+            ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+          }
 
         image_width=(size_t) mng_get_long(p);
         image_height=(size_t) mng_get_long(&p[4]);
